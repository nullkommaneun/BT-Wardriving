export class MapView{constructor(){this.map=null;this.markers=L.layerGroup();this.heat=null;this.hasHeat=!!L.heatLayer}init(id='map'){this.map=L.map(id,{zoomControl:true});L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(this.map);this.markers.addTo(this.map);this.map.setView([51.1657,10.4515],5)}clear(){this.markers.clearLayers();if(this.heat){this.map.removeLayer(this.heat);this.heat=null}}addRecord(r){if(typeof r.latitude!=='number'||typeof r.longitude!=='number')return;const popup=[`<b>${r.deviceName||'(kein Name)'}</b>`,`Zeit: ${r.timestamp}`,`RSSI: ${r.rssi} dBm`,`UUIDs: ${r.serviceUUIDs&&r.serviceUUIDs.length?r.serviceUUIDs.join(', '):'(leer)'}`,`Pos: ${r.latitude.toFixed(6)}, ${r.longitude.toFixed(6)}`].join('<br>');const m=L.marker([r.latitude,r.longitude]);m.bindPopup(popup);this.markers.addLayer(m)}fitToData(){const b=this.markers.getLayers().map(m=>m.getLatLng());if(b.length){this.map.fitBounds(L.latLngBounds(b),{padding:[24,24]})}}setHeat(rs){if(!this.hasHeat)return;if(this.heat){this.map.removeLayer(this.heat);this.heat=null}if(!rs.length)return;const toW=r=>{const mi=-90,ma=-30;const c=Math.max(mi,Math.min(ma,r));return(c-mi)/(ma-mi)};const pts=rs.filter(r=>typeof r.latitude==='number'&&typeof r.longitude==='number'&&Number.isFinite(r.rssi)).map(r=>[r.latitude,r.longitude,toW(r.rssi)]);if(!pts.length)return;this.heat=L.heatLayer(pts,{radius:25,blur:15,maxZoom:17});this.heat.addTo(this.map)}}